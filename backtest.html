<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Analisis Backtest</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* Disesuaikan untuk header yang lebih tinggi di desktop */
            padding-top: 7rem; 
        }
        .header-global {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            /* Padding default untuk mobile */
            padding: 1rem 1.5rem;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 50;
            color: #333333;
            /* Ukuran teks default untuk mobile (12px) */
            font-size: 0.75rem; 
        }
        .chart-container-wrapper {
            position: relative;
            height: 22rem;
        }

        @media (min-width: 768px) { /* md breakpoint untuk gaya desktop */
            .header-global {
                /* Padding untuk desktop */
                padding: 2rem 2.5rem; 
                /* Ukuran teks untuk desktop (14px) */
                font-size: 0.875rem; 
            }
        }

        @media (max-width: 767px) { /* Hanya untuk layar mobile */
            .chart-container-wrapper {
                height: auto;
                aspect-ratio: 16 / 9;
            }
        }
    </style>
</head>
<body>
    <!-- Global Header Component -->
    <header class="header-global">
        <!-- Logo/Brand Name (kelas text-sm dihapus) -->
        <div class="font-light">
            <a href="#">Backtest</a>
        </div>

        <!-- Desktop Navigation (kelas text-sm dihapus) -->
        <nav class="hidden md:flex items-center space-x-5 font-light">
            <a href="index.html" class="hover:text-blue-600 transition-colors">Home</a>
            <a href="about_new.html" class="hover:text-blue-600 transition-colors">About</a>
            <a href="services.html" class="hover:text-blue-600 transition-colors">Services</a>
            <a href="contact.html" class="hover:text-blue-600 transition-colors">Contact</a>
            <a href="beranda.html" class="hover:text-blue-600 transition-colors">Beranda</a>
            <a href="investasi.html" class="hover:text-blue-600 transition-colors">Investasi</a>
        </nav>

        <!-- Hamburger Menu Button (Mobile) -->
        <div class="md:hidden">
            <button id="hamburger-button" class="text-gray-700 focus:outline-none">
                <!-- Ikon Hamburger -->
                <svg id="hamburger-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
                <!-- Ikon Silang (Tutup), tersembunyi secara default -->
                <svg id="close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Mobile Menu (Initially hidden) -->
    <div id="mobile-menu" class="hidden fixed inset-0 bg-white z-40 flex flex-col items-center justify-center space-y-6">
        <!-- Tombol tutup terpisah dihapus -->
        <div id="mobile-datetime" class="text-gray-600 text-sm font-light text-center"></div>
        <nav class="flex flex-col items-center space-y-5 text-lg">
            <a href="index.html" class="hover:text-blue-600 transition-colors">Home</a>
            <a href="about_new.html" class="hover:text-blue-600 transition-colors">About</a>
            <a href="services.html" class="hover:text-blue-600 transition-colors">Services</a>
            <a href="contact.html" class="hover:text-blue-600 transition-colors">Contact</a>
            <a href="beranda.html" class="hover:text-blue-600 transition-colors">Beranda</a>
            <a href="investasi.html" class="hover:text-blue-600 transition-colors">Investasi</a>
        </nav>
    </div>
    
    <!-- Kontainer utama -->
    <div class="container mx-auto bg-white p-4 md:p-6 rounded-xl shadow-lg border border-gray-200 space-y-5">

        <!-- Bagian Header Utama -->
        <div class="bg-gray-900 text-white p-5 md:p-6 rounded-t-xl">
            <h1 class="text-2xl font-light text-center">Analisis Backtest Perdagangan</h1>
            <p class="text-center text-gray-400 font-light mt-1 text-sm">Laporan komprehensif dari data file CSV Anda.</p>
        </div>

        <div class="p-4 md:p-6 space-y-5">
            <!-- Bagian Unggah File -->
            <div class="flex justify-center items-center">
                <label id="upload-button" class="w-full md:w-auto inline-flex items-center justify-center px-6 py-2 bg-gray-900 text-white font-light rounded-full shadow-md hover:bg-gray-700 transform hover:scale-105 transition-all duration-200 cursor-pointer text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1" />
                        <polyline points="12 12 8 8 12 4" />
                        <line x1="12" y1="4" x2="12" y2="15" />
                    </svg>
                    Unggah File CSV
                    <input type="file" id="file-upload" accept=".csv" class="hidden" />
                </label>
            </div>

            <!-- Wadah untuk pesan status (loading atau error) -->
            <div id="status-container" class="text-center mt-3"></div>

            <!-- Bagian Hasil -->
            <div id="results-container" class="space-y-6 hidden">
                <!-- Statistik Ringkasan Utama -->
                <div id="primary-metrics-grid" class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-center">
                    <!-- Metrik utama akan dirender di sini -->
                </div>
                
                <!-- Statistik Tambahan (berturut-turut) -->
                <div id="secondary-metrics-grid" class="grid grid-cols-2 md:grid-cols-5 gap-3 text-center">
                    <!-- Metrik tambahan akan dirender di sini -->
                </div>

                <!-- Wadah untuk grafik Profit/Loss -->
                <div class="w-full">
                    <div class="bg-gray-100 p-3 rounded-xl shadow-inner mt-4 border border-gray-200 flex flex-col">
                        <h3 class="text-base font-light text-gray-900 text-center mb-3">Kurva Profit/Loss Kumulatif</h3>
                        <div class="chart-container-wrapper">
                            <canvas id="profitChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Bagian Input Simulasi Saldo -->
                <div class="bg-gray-100 p-5 md:p-6 rounded-xl shadow-md border border-gray-200 space-y-3">
                    <h3 id="compounding-title" class="text-lg font-light text-gray-900 text-center">Simulasi Saldo Perdagangan</h3>
                    <p class="text-gray-700 text-center text-sm">Masukkan detail di bawah untuk melihat potensi pertumbuhan saldo Anda.</p>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
                        <div>
                            <label for="initial-balance" class="block text-xs font-light text-gray-700">Saldo Awal</label>
                            <input type="number" id="initial-balance" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-xs p-2" placeholder="Saldo awal" value="1000">
                        </div>
                        <div>
                            <label for="risk-percentage" class="block text-xs font-light text-gray-700">Presentase per Trade (%)</label>
                            <input type="number" id="risk-percentage" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-xs p-2" placeholder="e.g., 1" value="1">
                        </div>
                        <div>
                            <label for="compounding-percentage" class="block text-xs font-light text-gray-700">Compounding Bulanan (%)</label>
                            <input type="number" id="compounding-percentage" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-xs p-2" placeholder="% bulanan" value="10">
                        </div>
                        <div>
                            <label for="compounding-period" class="block text-xs font-light text-gray-700">Periode (Bulan)</label>
                            <input type="number" id="compounding-period" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-xs p-2" placeholder="Periode (bulan)" value="12">
                        </div>
                    </div>
                </div>

                <!-- Wadah untuk grafik compounding -->
                <div class="w-full" id="compounding-chart-container" style="display:none;">
                     <div class="bg-gray-100 p-3 rounded-xl shadow-inner mt-4 border border-gray-200 flex flex-col">
                        <h3 id="compounding-chart-title" class="text-base font-light text-gray-900 text-center mb-3">Kurva Simulasi Saldo</h3>
                        <div class="chart-container-wrapper">
                            <canvas id="compoundingChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Wadah untuk tabel ringkasan bulanan -->
                <div id="monthly-summary-container" class="w-full" style="display:none;">
                    <div class="bg-gray-100 p-3 rounded-xl shadow-inner mt-4 border border-gray-200">
                        <h3 class="text-base font-light text-gray-900 text-center mb-3">Ringkasan P/L Bulanan (%)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-center text-[10px] leading-tight">
                                <thead class="border-b-2 border-gray-300">
                                    <tr id="monthly-summary-headers">
                                        <th class="p-2 font-light">Tahun</th>
                                        <th class="p-2 font-light">Jan</th>
                                        <th class="p-2 font-light">Feb</th>
                                        <th class="p-2 font-light">Mar</th>
                                        <th class="p-2 font-light">Apr</th>
                                        <th class="p-2 font-light">Mei</th>
                                        <th class="p-2 font-light">Jun</th>
                                        <th class="p-2 font-light">Jul</th>
                                        <th class="p-2 font-light">Agu</th>
                                        <th class="p-2 font-light">Sep</th>
                                        <th class="p-2 font-light">Okt</th>
                                        <th class="p-2 font-light">Nov</th>
                                        <th class="p-2 font-light">Des</th>
                                        <th class="p-2 font-light">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="monthly-summary-body"></tbody>
                                <tfoot id="monthly-summary-footer" class="border-t-2 border-gray-300"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Wadah untuk tabel CSV -->
                <div id="table-container" class="overflow-x-auto rounded-lg shadow-inner border border-gray-200 mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr id="table-headers"></tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>

                <!-- Panduan Penggunaan Backtest -->
                <div class="bg-gray-100 p-5 md:p-6 rounded-xl shadow-md border border-gray-200 space-y-4">
                    <h3 class="text-lg font-light text-gray-900 text-center">Panduan Penggunaan Backtest</h3>
                    <p class="text-gray-700 text-sm text-center">Selamat datang! Alat ini membantu Anda menguji strategi perdagangan menggunakan data historis. Ikuti langkah-langkah di bawah ini.</p>

                    <h4 class="font-light text-base text-gray-800 pt-3 border-t border-gray-300">Langkah 1: Siapkan File CSV Anda</h4>
                    <p class="text-gray-700 text-xs">Kunci dari analisis yang akurat adalah data yang bersih dan terstruktur. Pastikan file CSV Anda memiliki format yang benar.</p>
                    <ul class="list-disc list-inside ml-4 text-gray-700 text-xs space-y-1">
                        <li><strong>Header Wajib:</strong> File Anda harus memiliki baris pertama (header) dengan kolom berikut: <code>Pair;Action;Tanggal Entry;Tanggal Exit;Entry;TP;SL;Keterangan</code>.</li>
                        <li><strong>Pemisah:</strong> Gunakan titik koma (<code>;</code>) sebagai pemisah antar kolom. Ini penting!</li>
                        <li><strong>Penjelasan Kolom:</strong>
                            <ul class="list-disc list-inside ml-6 text-gray-600 text-xs">
                                <li><code>Pair</code>: Pasangan mata uang atau aset (misal: EURUSD).</li>
                                <li><code>Action</code>: Aksi yang diambil (misal: BUY atau SELL).</li>
                                <li><code>Tanggal Entry/Exit</code>: Tanggal masuk dan keluar posisi (format: DD-Mon-YY, misal: 01-Jan-24).</li>
                                <li><code>Entry</code>: Harga saat masuk posisi.</li>
                                <li><code>TP</code>: Harga Target Profit (Take Profit).</li>
                                <li><code>SL</code>: Harga Stop Loss.</li>
                                <li><code>Keterangan</code>: Hasil akhir perdagangan (harus diisi <strong>TP</strong> atau <strong>SL</strong>).</li>
                            </ul>
                        </li>
                    </ul>
                    <p class="text-gray-700 text-xs mt-2"><strong>Contoh Isi File CSV:</strong></p>
                    <pre class="bg-gray-200 p-2 rounded text-xs text-gray-800 overflow-x-auto"><code>Pair;Action;Tanggal Entry;Tanggal Exit;Entry;TP;SL;Keterangan
EURUSD;BUY;01-Jan-24;02-Jan-24;1.0900;1.1000;1.0850;TP
GBPUSD;SELL;03-Jan-24;03-Jan-24;1.2700;1.2600;1.2750;SL</code></pre>

                    <h4 class="font-light text-base text-gray-800 pt-3 border-t border-gray-300">Langkah 2: Unggah dan Analisis</h4>
                    <p class="text-gray-700 text-xs">Klik tombol "Unggah File CSV" dan pilih file yang sudah Anda siapkan. Sistem akan otomatis memproses data dan menampilkan hasilnya dalam beberapa detik.</p>

                    <h4 class="font-light text-base text-gray-800 pt-3 border-t border-gray-300">Langkah 3: Pahami Hasil Analisis</h4>
                    <p class="text-gray-700 text-xs">Setelah data diproses, Anda akan melihat metrik dan grafik untuk mengevaluasi performa strategi Anda.</p>
                    <ul class="list-disc list-inside ml-4 text-gray-700 text-xs space-y-1">
                        <li><strong>Probabilitas Menang:</strong> Persentase perdagangan yang ditutup dengan profit (TP). Semakin tinggi, semakin baik.</li>
                        <li><strong>P/L Kumulatif (Poin):</strong> Total keuntungan atau kerugian dalam poin dari semua perdagangan.</li>
                        <li><strong>Max Drawdown:</strong> Penurunan maksimum dari puncak ke lembah terendah dalam kurva profit Anda, baik dalam poin maupun persentase. Ini adalah indikator risiko penting.</li>
                        <li><strong>Avg. Risk:Reward:</strong> Rasio rata-rata antara potensi kerugian (SL) dan potensi keuntungan (TP). Rasio di atas 1:1 umumnya lebih disukai.</li>
                        <li><strong>Kurva Profit/Loss:</strong> Visualisasi pertumbuhan profit Anda dari waktu ke waktu. Kurva yang naik secara konsisten menunjukkan strategi yang stabil.</li>
                    </ul>

                    <h4 class="font-light text-base text-gray-800 pt-3 border-t border-gray-300">Langkah 4: Lakukan Simulasi Saldo</h4>
                    <p class="text-gray-700 text-xs">Gunakan bagian "Simulasi Saldo Perdagangan" untuk memproyeksikan bagaimana saldo akun riil Anda bisa tumbuh berdasarkan hasil backtest.</p>
                    <ul class="list-disc list-inside ml-4 text-gray-700 text-xs space-y-1">
                        <li><strong>Saldo Awal:</strong> Modal awal Anda dalam USD.</li>
                        <li><strong>Presentase per Trade (%):</strong> Risiko yang Anda ambil untuk setiap perdagangan sebagai persentase dari saldo saat ini.</li>
                        <li><strong>Compounding Bulanan (%):</strong> Persentase keuntungan yang ingin Anda reinvestasikan setiap bulan untuk proyeksi ke depan.</li>
                        <li><strong>Periode (Bulan):</strong> Lamanya periode simulasi untuk proyeksi ke depan.</li>
                    </ul>
                    <p class="text-gray-700 text-xs mt-2">Hasilnya akan ditampilkan pada <strong>Kurva Simulasi Saldo</strong>, memberikan gambaran visual tentang potensi pertumbuhan modal Anda.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Hamburger Menu Logic ---
        const hamburgerButton = document.getElementById('hamburger-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileDateTime = document.getElementById('mobile-datetime');
        const hamburgerIcon = document.getElementById('hamburger-icon');
        const closeIcon = document.getElementById('close-icon');

        function toggleMenu() {
            mobileMenu.classList.toggle('hidden');
            // Menukar ikon hamburger dan silang
            hamburgerIcon.classList.toggle('hidden');
            closeIcon.classList.toggle('hidden');
        }

        // Event listener sekarang hanya pada satu tombol
        hamburgerButton.addEventListener('click', toggleMenu);
        
        // Function to update date and time in the mobile menu
        function updateMobileDateTime() {
            const now = new Date();
            const dateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const dateString = now.toLocaleDateString('id-ID', dateOptions);
            const timeString = now.toLocaleTimeString('id-ID', timeOptions).replace(/\./g, ':');
            mobileDateTime.textContent = `${dateString} ${timeString}`;
        }
        setInterval(updateMobileDateTime, 1000);
        updateMobileDateTime(); // Initial call
        // --- End of Hamburger Menu Logic ---


        // Mendapatkan elemen HTML dari DOM
        const fileUpload = document.getElementById('file-upload');
        const statusContainer = document.getElementById('status-container');
        const resultsContainer = document.getElementById('results-container');
        const primaryMetricsGrid = document.getElementById('primary-metrics-grid');
        const secondaryMetricsGrid = document.getElementById('secondary-metrics-grid');
        const profitChartCanvas = document.getElementById('profitChart');
        const tableContainer = document.getElementById('table-container');
        const tableHeaders = document.getElementById('table-headers');
        const tableBody = document.getElementById('table-body');
        
        const initialBalanceInput = document.getElementById('initial-balance');
        const riskPercentageInput = document.getElementById('risk-percentage');
        const compoundingPercentageInput = document.getElementById('compounding-percentage');
        const compoundingPeriodInput = document.getElementById('compounding-period');
        const compoundingChartCanvas = document.getElementById('compoundingChart');
        const compoundingChartContainer = document.getElementById('compounding-chart-container');
        
        const monthlySummaryContainer = document.getElementById('monthly-summary-container');
        const monthlySummaryBody = document.getElementById('monthly-summary-body');
        const monthlySummaryFooter = document.getElementById('monthly-summary-footer');
        
        let profitChartInstance;
        let compoundingChartInstance;
        let csvData = [];
        let rawCsvText = '';

        function parseDate(dateString) {
            const parts = dateString.split('-');
            if (parts.length !== 3) return null;
            const day = parseInt(parts[0], 10);
            const monthName = parts[1];
            if (!monthName) return null;
            const month = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].indexOf(monthName);
            if (month === -1) return null;
            let year = parseInt(parts[2], 10);
            if (year < 100) year = 2000 + year;
            return new Date(year, month, day);
        }

        function parseCsv(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 1) return [];
            const headers = lines[0].split(';').map(header => header.trim());
            const data = lines.slice(1).map(line => {
                const values = line.split(';').map(value => value.trim());
                if (values.length !== headers.length) return null;
                let row = {};
                headers.forEach((header, i) => { row[header] = values[i]; });
                return row;
            }).filter(row => row !== null);
            return data;
        }

        function calculateStatistics(data) {
            let cumulativeProfit = 0, peak = 0, maxDrawdownPoints = 0;
            let profitHistory = [{ trade: 0, profit: 0 }];
            let totalTrades = 0, winCount = 0;
            let currentTPStreak = 0, maxTPStreak = 0, currentSLStreak = 0, maxSLStreak = 0;
            let totalTPDistance = 0, totalSLDistance = 0, tpCount = 0, slCount = 0;
            let totalHoldingDays = 0;
            
            data.forEach((trade, index) => {
                const entryPrice = parseFloat(trade['Entry']);
                const tpPrice = parseFloat(trade['TP']);
                const slPrice = parseFloat(trade['SL']);
                const keterangan = trade['Keterangan'].toUpperCase();

                if (isNaN(entryPrice) || isNaN(tpPrice) || isNaN(slPrice)) return;
                
                totalTrades++;
                let profitLossPoints = 0;
                const tpDistance = Math.abs(tpPrice - entryPrice);
                const slDistance = Math.abs(slPrice - entryPrice);

                if (keterangan === 'TP') {
                    profitLossPoints = tpDistance;
                    winCount++;
                    currentTPStreak++;
                    currentSLStreak = 0;
                    if (currentTPStreak > maxTPStreak) maxTPStreak = currentTPStreak;
                    totalTPDistance += tpDistance;
                    tpCount++;
                } else if (keterangan === 'SL') {
                    profitLossPoints = -slDistance;
                    currentSLStreak++;
                    currentTPStreak = 0;
                    if (currentSLStreak > maxSLStreak) maxSLStreak = currentSLStreak;
                    totalSLDistance += slDistance;
                    slCount++;
                }

                cumulativeProfit += profitLossPoints;
                if (cumulativeProfit > peak) peak = cumulativeProfit;
                const drawdown = peak - cumulativeProfit;
                if (drawdown > maxDrawdownPoints) maxDrawdownPoints = drawdown;
                profitHistory.push({ trade: index + 1, profit: cumulativeProfit });

                try {
                    const entryDate = parseDate(trade['Tanggal Entry']);
                    const exitDate = parseDate(trade['Tanggal Exit']);
                    if (entryDate && exitDate) {
                        totalHoldingDays += (exitDate.getTime() - entryDate.getTime()) / (1000 * 60 * 60 * 24);
                    }
                } catch (e) { console.error("Error parsing dates:", e); }
            });

            const winRate = totalTrades > 0 ? (winCount / totalTrades) * 100 : 0;
            const avgTPDistance = tpCount > 0 ? totalTPDistance / tpCount : 0;
            const avgSLDistance = slCount > 0 ? totalSLDistance / slCount : 0;
            const avgRiskReward = avgTPDistance > 0 ? (avgSLDistance / avgTPDistance) : 0;
            const avgHoldingPeriod = totalTrades > 0 ? totalHoldingDays / totalTrades : 0;
            
            let totalDays = 0;
            if (data.length > 1) {
                const firstTradeDate = parseDate(data[0]['Tanggal Entry']);
                const lastTradeDate = parseDate(data[data.length - 1]['Tanggal Exit']);
                if (firstTradeDate && lastTradeDate) {
                    totalDays = (lastTradeDate.getTime() - firstTradeDate.getTime()) / (1000 * 60 * 60 * 24);
                }
            }

            return {
                totalTrades, finalProfit: cumulativeProfit, winRate: winRate.toFixed(2),
                maxDrawdownPoints, maxTPStreak, maxSLStreak,
                avgRiskReward: avgRiskReward.toFixed(2), avgHoldingPeriod: avgHoldingPeriod.toFixed(2),
                profitHistory, totalDays
            };
        }
        
        function calculateMonthlySummary(data, initialBalance, riskPercentage) {
            if (isNaN(initialBalance) || isNaN(riskPercentage) || riskPercentage <= 0 || data.length === 0) {
                return { percentageSummary: {}, yearlyTotals: {}, overallTotalPercentage: 0, monthlyTradeCounts: {}, yearlyTradeCounts: {}, overallTotalTrades: 0 };
            }

            const monthlyPL = {};
            const yearlyPL = {};
            const openingBalances = {};
            const monthlyTradeCounts = {};
            const yearlyTradeCounts = {};
            let overallTotalTrades = 0;
            let currentBalance = initialBalance;
            let totalPL = 0;

            const sortedData = [...data].sort((a, b) => {
                const dateA = parseDate(a['Tanggal Exit']);
                const dateB = parseDate(b['Tanggal Exit']);
                return (dateA && dateB) ? dateA - dateB : 0;
            });

            sortedData.forEach(trade => {
                const exitDate = parseDate(trade['Tanggal Exit']);
                if (!exitDate) return;

                const year = exitDate.getFullYear();
                const month = exitDate.getMonth();
                const yearMonthKey = `${year}-${month}`;

                if (openingBalances[yearMonthKey] === undefined) {
                    openingBalances[yearMonthKey] = currentBalance;
                }
                if (openingBalances[year] === undefined) {
                    openingBalances[year] = currentBalance;
                }

                if (!monthlyPL[year]) monthlyPL[year] = Array(12).fill(0);
                if (!yearlyPL[year]) yearlyPL[year] = 0;
                if (!monthlyTradeCounts[year]) monthlyTradeCounts[year] = Array(12).fill(0);
                if (!yearlyTradeCounts[year]) yearlyTradeCounts[year] = 0;

                const entryPrice = parseFloat(trade['Entry']);
                const tpPrice = parseFloat(trade['TP']);
                const slPrice = parseFloat(trade['SL']);
                const keterangan = trade['Keterangan'].toUpperCase();
                if (isNaN(entryPrice) || isNaN(tpPrice) || isNaN(slPrice)) return;
                
                const riskAmount = currentBalance * (riskPercentage / 100);
                const slDistancePoints = Math.abs(slPrice - entryPrice);
                const dynamicLotSize = slDistancePoints > 0 ? riskAmount / slDistancePoints : 0;

                let profitLossPoints = 0;
                if (keterangan === 'TP') profitLossPoints = Math.abs(tpPrice - entryPrice);
                else if (keterangan === 'SL') profitLossPoints = -Math.abs(slPrice - entryPrice);
                
                const profitLossCurrency = profitLossPoints * dynamicLotSize;

                monthlyPL[year][month] += profitLossCurrency;
                yearlyPL[year] += profitLossCurrency;
                totalPL += profitLossCurrency;
                currentBalance += profitLossCurrency;
                
                monthlyTradeCounts[year][month]++;
                yearlyTradeCounts[year]++;
                overallTotalTrades++;
            });

            const percentageSummary = {};
            const yearlyTotals = {};
            
            for (const year in monthlyPL) {
                percentageSummary[year] = Array(12).fill(0);
                for (let month = 0; month < 12; month++) {
                    const openingBalance = openingBalances[`${year}-${month}`];
                    const pl = monthlyPL[year][month];
                    if (openingBalance !== undefined && openingBalance > 0 && pl !== 0) {
                        percentageSummary[year][month] = (pl / openingBalance) * 100;
                    }
                }
                const yearOpeningBalance = openingBalances[year];
                if(yearOpeningBalance > 0){
                    yearlyTotals[year] = (yearlyPL[year] / yearOpeningBalance) * 100;
                } else {
                    yearlyTotals[year] = 0;
                }
            }

            const overallTotalPercentage = initialBalance > 0 ? (totalPL / initialBalance) * 100 : 0;

            return { percentageSummary, yearlyTotals, overallTotalPercentage, monthlyTradeCounts, yearlyTradeCounts, overallTotalTrades };
        }


        function renderMonthlySummaryTable({ percentageSummary, yearlyTotals, overallTotalPercentage, monthlyTradeCounts, yearlyTradeCounts, overallTotalTrades }) {
            monthlySummaryBody.innerHTML = '';
            monthlySummaryFooter.innerHTML = '';

            if (Object.keys(percentageSummary).length === 0) {
                monthlySummaryContainer.style.display = 'none';
                return;
            }

            const years = Object.keys(percentageSummary).sort();

            years.forEach(year => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200';
                
                const yearTd = document.createElement('td');
                yearTd.className = 'p-2 font-light';
                yearTd.textContent = year;
                tr.appendChild(yearTd);

                for (let i = 0; i < 12; i++) {
                    const profitPercentage = percentageSummary[year][i];
                    const tradeCount = monthlyTradeCounts[year] ? monthlyTradeCounts[year][i] : 0;
                    const monthTd = document.createElement('td');
                    monthTd.className = `p-2`;
                    monthTd.innerHTML = `
                        <p class="font-light ${profitPercentage > 0 ? 'text-black' : profitPercentage < 0 ? 'text-red-600' : 'text-gray-500'}">
                            ${profitPercentage !== 0 ? `${profitPercentage.toFixed(2)}%` : '-'}
                        </p>
                        ${tradeCount > 0 ? `<p class="text-[9px] text-gray-500 mt-0.5">(${tradeCount})</p>` : ''}
                    `;
                    tr.appendChild(monthTd);
                }

                const totalYearPercentage = yearlyTotals[year];
                const totalYearTrades = yearlyTradeCounts[year] || 0;
                const totalTd = document.createElement('td');
                totalTd.className = `p-2`;
                totalTd.innerHTML = `
                    <p class="font-light ${totalYearPercentage > 0 ? 'text-black' : totalYearPercentage < 0 ? 'text-red-600' : 'text-gray-500'}">
                        ${totalYearPercentage !== 0 ? `${totalYearPercentage.toFixed(2)}%` : '-'}
                    </p>
                    ${totalYearTrades > 0 ? `<p class="text-[9px] text-gray-500 mt-0.5">(${totalYearTrades})</p>` : ''}
                `;
                tr.appendChild(totalTd);

                monthlySummaryBody.appendChild(tr);
            });
            
            const footerTr = document.createElement('tr');
            const footerLabelTd = document.createElement('td');
            footerLabelTd.colSpan = "13";
            footerLabelTd.className = "p-2 text-right font-light";
            footerLabelTd.textContent = "Total Keseluruhan";
            footerTr.appendChild(footerLabelTd);

            const footerValueTd = document.createElement('td');
            footerValueTd.className = `p-2`;
            footerValueTd.innerHTML = `
                <p class="font-light ${overallTotalPercentage > 0 ? 'text-black' : overallTotalPercentage < 0 ? 'text-red-600' : 'text-gray-500'}">
                    ${overallTotalPercentage.toFixed(2)}%
                </p>
                ${overallTotalTrades > 0 ? `<p class="text-[9px] text-gray-500 mt-0.5">(${overallTotalTrades})</p>` : ''}
            `;
            footerTr.appendChild(footerValueTd);
            
            monthlySummaryFooter.appendChild(footerTr);
            monthlySummaryContainer.style.display = 'block';
        }


        function calculatePercentageDrawdown(balanceHistory) {
            let peak = 0, maxDrawdown = 0;
            balanceHistory.forEach(item => {
                if (item.balance > peak) peak = item.balance;
                const drawdown = peak - item.balance;
                if (drawdown > maxDrawdown) maxDrawdown = drawdown;
            });
            return peak > 0 ? (maxDrawdown / peak) * 100 : 0;
        }

        function calculateAvgReturns(balanceHistory, totalDays) {
            if (totalDays <= 0) return { daily: 0, monthly: 0, yearly: 0 };
            const initialBalance = balanceHistory[0].balance;
            const finalBalance = balanceHistory[balanceHistory.length - 1].balance;
            if (initialBalance <= 0) return { daily: 0, monthly: 0, yearly: 0 };
            const totalReturn = (finalBalance - initialBalance) / initialBalance;
            const avgDailyReturn = (Math.pow(1 + totalReturn, 1 / totalDays) - 1);
            const avgMonthlyReturn = (Math.pow(1 + avgDailyReturn, 30) - 1) * 100;
            const avgYearlyReturn = (Math.pow(1 + avgDailyReturn, 365) - 1) * 100;
            return { daily: avgDailyReturn * 100, monthly: avgMonthlyReturn, yearly: avgYearlyReturn };
        }
        
        function calculateCompoundingProjection(initialBalance, monthlyRate, periodInMonths) {
            if (isNaN(initialBalance) || isNaN(monthlyRate) || isNaN(periodInMonths)) return 0;
            return initialBalance * Math.pow(1 + (monthlyRate / 100), periodInMonths);
        }

        function renderTable(data) {
            tableHeaders.innerHTML = '';
            tableBody.innerHTML = '';
            if (data.length === 0) {
                tableContainer.classList.add('hidden');
                return;
            }
            const headers = Object.keys(data[0]);
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-2 py-2 text-left text-xs font-light text-gray-500 uppercase tracking-wider';
                th.textContent = header;
                tableHeaders.appendChild(th);
            });
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.className = 'px-2 py-2 whitespace-nowrap text-xs text-gray-800 font-light';
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
            tableContainer.classList.remove('hidden');
        }

        function renderMetrics(metrics, drawdownPercentage, avgReturns, finalCompoundingBalance, avgProfitPerTradePercentage) {
            primaryMetricsGrid.innerHTML = '';
            secondaryMetricsGrid.innerHTML = '';
            
            const formatPLPoints = (value) => {
                const multiplied = value * 10;
                return multiplied.toLocaleString('en-US', {
                    minimumFractionDigits: 1,
                    maximumFractionDigits: 1,
                });
            };

            const primaryMetricsList = [
                { label: 'Total Perdagangan', value: metrics.totalTrades },
                { label: 'Probabilitas Menang', value: `${metrics.winRate}%`},
                { label: 'P/L Kumulatif (Poin)', value: formatPLPoints(metrics.finalProfit) },
            ];
            primaryMetricsList.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-gray-100 p-3 rounded-lg shadow-md border border-gray-200';
                card.innerHTML = `<p class="text-xs font-light text-gray-700">${item.label}</p><p class="text-xl font-light text-gray-900 mt-1">${item.value}</p>`;
                primaryMetricsGrid.appendChild(card);
            });
            
            const secondaryMetricsList = [
                { label: 'Max Drawdown (Poin)', value: metrics.maxDrawdownPoints.toFixed(2) },
                { label: 'Max Drawdown (%)', value: `${drawdownPercentage.toFixed(2)}%`},
                { label: 'Avg. Profit/Trade (%)', value: `${avgProfitPerTradePercentage.toFixed(2)}%` },
                { label: 'Avg. Kenaikan Bulanan', value: `${avgReturns.monthly.toFixed(2)}%` },
                { label: 'Avg. Kenaikan Tahunan', value: `${avgReturns.yearly.toFixed(2)}%` },
                { label: 'Proyeksi Saldo Akhir', value: `$${finalCompoundingBalance.toLocaleString('en-US', {minimumFractionDigits: 3, maximumFractionDigits: 3})}` },
                { label: 'TP Berturut-turut', value: metrics.maxTPStreak },
                { label: 'SL Berturut-turut', value: metrics.maxSLStreak },
                { label: 'Avg. Risk:Reward', value: `1:${metrics.avgRiskReward}` },
                { label: 'Avg. Holding', value: `${metrics.avgHoldingPeriod} hari` },
            ];
            secondaryMetricsGrid.classList.add('grid-cols-2', 'sm:grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-5');
            secondaryMetricsGrid.innerHTML = '';
            secondaryMetricsList.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-gray-100 p-3 rounded-lg shadow-md border border-gray-200';
                card.innerHTML = `<p class="text-xs font-light text-gray-700">${item.label}</p><p class="text-xl font-light text-gray-900 mt-1">${item.value}</p>`;
                secondaryMetricsGrid.appendChild(card);
            });
        }
        
        const chartFontOptions = {
            font: { size: 10 },
            color: '#6b7280'
        };

        function renderProfitChart(history) {
            if (profitChartInstance) profitChartInstance.destroy();
            profitChartInstance = new Chart(profitChartCanvas, {
                type: 'line',
                data: {
                    labels: history.map(item => item.trade),
                    datasets: [{
                        label: 'Profit/Loss',
                        data: history.map(item => item.profit),
                        borderColor: 'rgb(0, 0, 0)',
                        backgroundColor: 'rgba(0, 0, 0, 0.05)',
                        borderWidth: 1, tension: 0.2, pointRadius: 0, pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { titleFont: { size: 10 }, bodyFont: { size: 10 } } },
                    scales: {
                        x: { title: { display: true, text: 'Jumlah Perdagangan', font: chartFontOptions.font, color: chartFontOptions.color }, ticks: { font: { size: 9 } } },
                        y: { 
                            title: { display: true, text: 'P/L Kumulatif (Poin)', font: chartFontOptions.font, color: chartFontOptions.color }, 
                            ticks: { 
                                font: { size: 9 },
                                callback: function(value, index, values) {
                                    const multiplied = value * 10;
                                    return multiplied.toLocaleString('en-US', {
                                        minimumFractionDigits: 1,
                                        maximumFractionDigits: 1,
                                    });
                                }
                            } 
                        }
                    }
                }
            });
        }
        
        function calculateAndRenderBalanceCurve() {
            const initialBalance = parseFloat(initialBalanceInput.value);
            const riskPercentage = parseFloat(riskPercentageInput.value);
            const compoundingPercentage = parseFloat(compoundingPercentageInput.value);
            const compoundingPeriod = parseInt(compoundingPeriodInput.value, 10);
            
            if (isNaN(initialBalance) || isNaN(riskPercentage) || !csvData.length) {
                compoundingChartContainer.style.display = 'none';
                return;
            }
            compoundingChartContainer.style.display = 'block';

            let balanceHistory = [{ trade: 0, balance: initialBalance }];
            let currentBalance = initialBalance;
            let totalProfitCurrency = 0;
            
            csvData.forEach((trade, index) => {
                const entryPrice = parseFloat(trade['Entry']);
                const tpPrice = parseFloat(trade['TP']);
                const slPrice = parseFloat(trade['SL']);
                const keterangan = trade['Keterangan'].toUpperCase();
                if (isNaN(entryPrice) || isNaN(tpPrice) || isNaN(slPrice)) return;
                
                const riskAmount = currentBalance * (riskPercentage / 100);
                const slDistancePoints = Math.abs(slPrice - entryPrice);
                const dynamicLotSize = slDistancePoints > 0 ? riskAmount / slDistancePoints : 0;

                let profitLossPoints = 0;
                if (keterangan === 'TP') profitLossPoints = Math.abs(tpPrice - entryPrice);
                else if (keterangan === 'SL') profitLossPoints = -Math.abs(slPrice - entryPrice);
                
                const tradeProfit = profitLossPoints * dynamicLotSize;
                currentBalance += tradeProfit;
                totalProfitCurrency += tradeProfit;
                balanceHistory.push({ trade: index + 1, balance: currentBalance });
            });
            
            let lastHistoricalBalance = balanceHistory[balanceHistory.length - 1].balance;
            let projectionData = [];
            let projectionBalance = lastHistoricalBalance;
            for (let i = 0; i < compoundingPeriod; i++) {
                projectionBalance *= (1 + compoundingPercentage / 100);
                projectionData.push(projectionBalance);
            }
            const finalCompoundingBalance = projectionBalance;

            const historicalLabels = balanceHistory.map(item => `Trade ${item.trade}`);
            const projectionLabels = Array.from({ length: compoundingPeriod }, (_, i) => `Bln ${i + 1}`);
            const chartLabels = historicalLabels.concat(projectionLabels);

            const historicalDataset = balanceHistory.map(item => item.balance);
            const projectionDataset = [
                ...new Array(balanceHistory.length - 1).fill(null),
                lastHistoricalBalance,
                ...projectionData
            ];

            if (compoundingChartInstance) compoundingChartInstance.destroy();
            compoundingChartInstance = new Chart(compoundingChartCanvas, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: 'Riwayat Saldo',
                            data: historicalDataset,
                            borderColor: 'rgb(220, 38, 38)',
                            backgroundColor: 'rgba(220, 38, 38, 0.05)',
                            borderWidth: 1.5,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0
                        },
                        {
                            label: 'Proyeksi Saldo',
                            data: projectionDataset,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.05)',
                            borderWidth: 1.5,
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: true, labels: { font: {size: 10} } }, tooltip: { titleFont: { size: 10 }, bodyFont: { size: 10 } } },
                    scales: {
                        x: { title: { display: true, text: 'Linimasa (Perdagangan & Proyeksi Bulan)', font: chartFontOptions.font, color: chartFontOptions.color }, ticks: { font: { size: 9 } } },
                        y: { 
                            title: { display: true, text: 'Saldo ($)', font: chartFontOptions.font, color: chartFontOptions.color }, 
                            ticks: { 
                                font: { size: 9 },
                                callback: function(value, index, values) {
                                    return value.toLocaleString('en-US', {
                                        style: 'currency',
                                        currency: 'USD',
                                        minimumFractionDigits: 3,
                                        maximumFractionDigits: 3,
                                    });
                                }
                            } 
                        }
                    }
                }
            });

            const drawdownPercentage = calculatePercentageDrawdown(balanceHistory);
            const { totalDays } = calculateStatistics(csvData);
            const avgReturns = calculateAvgReturns(balanceHistory, totalDays);
            const totalTrades = csvData.length;
            const avgProfitPerTradeCurrency = totalTrades > 0 ? totalProfitCurrency / totalTrades : 0;
            const avgProfitPerTradePercentage = initialBalance > 0 ? (avgProfitPerTradeCurrency / initialBalance) * 100 : 0;
            const metrics = calculateStatistics(csvData);

            renderMetrics(metrics, drawdownPercentage, avgReturns, finalCompoundingBalance, avgProfitPerTradePercentage);
            
            const monthlySummaryData = calculateMonthlySummary(csvData, initialBalance, riskPercentage);
            renderMonthlySummaryTable(monthlySummaryData);
            saveState();
        }
        
        function runFullAnalysis(csvText) {
            try {
                rawCsvText = csvText;
                csvData = parseCsv(rawCsvText);
                if (csvData.length > 0) {
                    const metrics = calculateStatistics(csvData);
                    
                    statusContainer.innerHTML = '';
                    resultsContainer.classList.remove('hidden');
                    
                    calculateAndRenderBalanceCurve();
                    renderProfitChart(metrics.profitHistory);
                    renderTable(csvData);
                } else {
                    throw new Error('Tidak ada data yang valid di file CSV.');
                }
            } catch (err) {
                console.error("Error processing file:", err);
                statusContainer.innerHTML = `<p class="text-red-600 font-light text-sm">Kesalahan: ${err.message}.</p>`;
                resultsContainer.classList.add('hidden');
            }
        }

        function saveState() {
            if (rawCsvText) {
                localStorage.setItem('savedCsvData', rawCsvText);
            }
            const inputs = {
                initialBalance: initialBalanceInput.value,
                riskPercentage: riskPercentageInput.value,
                compoundingPercentage: compoundingPercentageInput.value,
                compoundingPeriod: compoundingPeriodInput.value,
            };
            localStorage.setItem('savedInputs', JSON.stringify(inputs));
        }

        function loadState() {
            const savedInputs = localStorage.getItem('savedInputs');
            if (savedInputs) {
                const inputs = JSON.parse(savedInputs);
                initialBalanceInput.value = inputs.initialBalance || '1000';
                riskPercentageInput.value = inputs.riskPercentage || '1';
                compoundingPercentageInput.value = inputs.compoundingPercentage || '10';
                compoundingPeriodInput.value = inputs.compoundingPeriod || '12';
            }

            const savedCsvData = localStorage.getItem('savedCsvData');
            if (savedCsvData) {
                runFullAnalysis(savedCsvData);
            }
        }

        fileUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            statusContainer.innerHTML = `<div class="flex justify-center items-center"><div class="w-6 h-6 border-4 border-dashed rounded-full animate-spin border-gray-900"></div></div>`;
            resultsContainer.classList.add('hidden');
            const reader = new FileReader();
            reader.onload = (e) => {
                runFullAnalysis(e.target.result);
            };
            reader.onerror = () => {
                statusContainer.innerHTML = `<p class="text-red-600 font-light text-sm">Terjadi kesalahan saat membaca file.</p>`;
                resultsContainer.classList.add('hidden');
            };
            reader.readAsText(file);
        });
        
        document.addEventListener('DOMContentLoaded', loadState);

        [initialBalanceInput, riskPercentageInput, compoundingPercentageInput, compoundingPeriodInput].forEach(input => {
            input.addEventListener('input', () => {
                if (csvData.length > 0) {
                    calculateAndRenderBalanceCurve();
                }
            });
        });
    </script>
</body>
</html>
